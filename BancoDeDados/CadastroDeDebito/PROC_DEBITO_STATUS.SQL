CREATE TABLE PROJUDI.PROC_DEBITO_STATUS (	
	ID_PROC_DEBITO_STATUS   NUMBER(24,0)       NOT NULL ENABLE, 
	PROC_DEBITO_STATUS      VARCHAR2(60 CHAR)  NOT NULL ENABLE,
	CODIGO_TEMP             NUMBER(10,0), 
CONSTRAINT PROC_DEBITO_STATUS_PK PRIMARY KEY (ID_PROC_DEBITO_STATUS));

CREATE OR REPLACE FORCE VIEW PROJUDI.VIEW_PROC_DEBITO_STATUS AS 
  SELECT PDS.ID_PROC_DEBITO_STATUS    AS ID_PROC_DEBITO_STATUS,
	PDS.PROC_DEBITO_STATUS            AS PROC_DEBITO_STATUS,
	PDS.CODIGO_TEMP                   AS CODIGO_TEMP
  FROM PROJUDI.PROC_DEBITO_STATUS PDS;

CREATE SEQUENCE  PROJUDI.PROCDEBITOSTATUS_ID_SEQ  MINVALUE 1 MAXVALUE 9999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE  NOORDER  NOCYCLE;

CREATE OR REPLACE TRIGGER PROJUDI.PROCDEBITOSTATUS_ID_TRG BEFORE INSERT OR UPDATE ON PROC_DEBITO_STATUS
FOR EACH ROW
DECLARE
v_newVal NUMBER(12) := 0;
v_incval NUMBER(12) := 0;
BEGIN
  IF INSERTING AND :new.ID_PROC_DEBITO_STATUS IS NULL THEN
    SELECT  PROCDEBITOSTATUS_ID_SEQ.NEXTVAL INTO v_newVal FROM DUAL;
    IF v_newVal = 1 THEN
      SELECT NVL(max(ID_PROC_DEBITO_STATUS),0) INTO v_newVal FROM PROC_DEBITO_STATUS;
      v_newVal := v_newVal + 1;
      LOOP
           EXIT WHEN v_incval>=v_newVal;
           SELECT PROCDEBITOSTATUS_ID_SEQ.nextval INTO v_incval FROM dual;
      END LOOP;
    END IF;    
   :new.ID_PROC_DEBITO_STATUS := v_newVal;
  END IF;
END;

ALTER TRIGGER PROJUDI.PROCDEBITOSTATUS_ID_TRG ENABLE;

--INSERTS DE PERMISSÃO
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24981','914','Processo Débito Status','27',null,'1','ProcessoDebitoStatus','userMainFrame','Cadastro de Débitos Status','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24982','9140','Processo Débito Status EXCLUIR','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24983','9141','Processo Débito Status IMPRIMIR','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24984','9142','Processo Débito Status LOCALIZAR','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24985','9143','Processo Débito Status LOCALIZARDWR','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24986','9144','Processo Débito Status NOVO','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24987','9145','Processo Débito Status SALVAR','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24988','9146','Processo Débito Status CURINGA6','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24989','9147','Processo Débito Status CURINGA7','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24990','9148','Processo Débito Status CURINGA8','24981',null,'0','#','userMainFrame',' ','1000',null);
Insert into PROJUDI.PERM (ID_PERM,PERM_CODIGO,PERM,ID_PERM_PAI,ID_PERM_ESPECIAL,E_MENU,LINK,IR_PARA,TITULO,ORDENACAO,CODIGO_TEMP) values ('24991','9149','Processo Débito Status CURINGA9','24981',null,'0','#','userMainFrame',' ','1000',null);


INSERT INTO PROC_DEBITO_STATUS VALUES (1, 'Novo', null);
INSERT INTO PROC_DEBITO_STATUS VALUES (2, 'Em Análise pelo Financeiro', null);
INSERT INTO PROC_DEBITO_STATUS VALUES (3, 'Devolvido pelo Financeiro', null);
INSERT INTO PROC_DEBITO_STATUS VALUES (4, 'Suspenso', null);
INSERT INTO PROC_DEBITO_STATUS VALUES (5, 'Liberado para Envio ao Cadin', null);
INSERT INTO PROC_DEBITO_STATUS VALUES (6, 'Enviado ao Cadin', null);
INSERT INTO PROC_DEBITO_STATUS VALUES (7, 'Baixado', null);

ALTER TABLE PROJUDI.PROC_PARTE_DEBITO ADD ID_PROC_DEBITO_STATUS NUMBER(24,0) NULL;

CREATE INDEX PROJUDI.PROC_PARTE_DEBITO_IDSTATUS_IDX ON PROJUDI.PROC_PARTE_DEBITO (ID_PROC_DEBITO_STATUS);

ALTER TABLE PROJUDI.PROC_PARTE_DEBITO ADD CONSTRAINT PROCPARTEDEB_PROCDEBSTATUS_FK FOREIGN KEY (ID_PROC_DEBITO_STATUS) REFERENCES PROJUDI.PROC_DEBITO_STATUS (ID_PROC_DEBITO_STATUS);

UPDATE PROC_PARTE_DEBITO SET DATA_BAIXA = NULL WHERE STATUS = 1; 

UPDATE PROC_PARTE_DEBITO SET ID_PROC_DEBITO_STATUS = 1 WHERE STATUS = 1 AND DATA_BAIXA IS NULL;

UPDATE PROC_PARTE_DEBITO SET ID_PROC_DEBITO_STATUS = 7 WHERE STATUS = 0 AND DATA_BAIXA IS NOT NULL;

UPDATE PROC_PARTE_DEBITO SET ID_PROC_DEBITO_STATUS = 5 WHERE LIBERADO_CADIN = '1';

ALTER TABLE PROC_PARTE_DEBITO DROP COLUMN STATUS; 

ALTER TABLE PROC_PARTE_DEBITO DROP COLUMN LIBERADO_CADIN; 

UPDATE PROJUDI.PROC_PARTE_DEBITO SET ID_PROC_DEBITO_STATUS = 1 WHERE ID_PROC_DEBITO_STATUS IS NULL;

ALTER TABLE PROJUDI.PROC_PARTE_DEBITO MODIFY ID_PROC_DEBITO_STATUS NUMBER(24,0) NOT NULL ENABLE;

ALTER TABLE PROC_PARTE_DEBITO ADD DIVIDA_SOLIDARIA CHAR(1) DEFAULT '0';

CREATE OR REPLACE FORCE VIEW PROJUDI.VIEW_PROC_PARTE_DEBITO AS 
  SELECT PPD.ID_PROC_PARTE_DEBITO AS ID_PROC_PARTE_DEBITO,
    PPD.ID_PROC_DEBITO            AS ID_PROC_DEBITO,
    PD.PROC_DEBITO                AS PROC_DEBITO,
    PPD.ID_PROC_PARTE             AS ID_PROC_PARTE,
    PP.NOME                       AS NOME,
    PP.NOME_SIMPLIFICADO          AS NOME_SIMPLIFICADO,
    PPT.PROC_PARTE_TIPO_CODIGO    AS PROC_PARTE_TIPO_CODIGO,
    PPT.PROC_PARTE_TIPO           AS PROC_PARTE_TIPO,
    PPD.CODIGO_TEMP               AS CODIGO_TEMP,
    PP.CPF                        AS CPF,
    PP.CNPJ                       AS CNPJ,
    P.ID_PROC                     AS ID_PROC,
    (P.PROC_NUMERO
    || '.'
    || P.DIGITO_VERIFICADOR)      AS PROC_NUMERO,
    LPAD(P.PROC_NUMERO, 7, '0')
    || '.'
    || LPAD (P.DIGITO_VERIFICADOR, 2, '0') 
    || '.'
    || LPAD (P.ANO, 4, '0') 
    || '.'
    || '8' 
    || '.'
    || '09' 
    || '.'
    || LPAD (P.FORUM_CODIGO, 4, '0') AS PROC_NUMERO_COMPLETO,
    P.PROC_NUMERO                    AS PROCESSO_NUMERO,
    P.DIGITO_VERIFICADOR             AS DIGITO_VERIFICADOR,
    P.ID_SERV                        AS ID_SERV,
    S.SERV                           AS SERV,
    GE.ID_GUIA_EMIS                  AS ID_GUIA_EMIS,
    GE.NUMERO_GUIA_COMPLETO          AS NUMERO_GUIA_COMPLETO,
    GT.ID_GUIA_TIPO                  AS ID_GUIA_TIPO,
    GT.GUIA_TIPO                     AS GUIA_TIPO,
    GS.ID_GUIA_STATUS                AS ID_GUIA_STATUS,
    GS.GUIA_STATUS                   AS GUIA_STATUS,
    (SELECT SUM(VALOR_CALCULADO) 
        FROM PROJUDI.GUIA_ITEM GI
     WHERE GI.ID_GUIA_EMIS = GE.ID_GUIA_EMIS) AS VALOR_TOTAL_GUIA,
    PPD.NUMERO_PROAD                 AS NUMERO_PROAD,
    PPD.ID_PROC_DEBITO_STATUS        AS ID_PROC_DEBITO_STATUS,
    PDS.PROC_DEBITO_STATUS           AS PROC_DEBITO_STATUS,
    PPD.DATA_BAIXA                   AS DATA_BAIXA,
    PPD.DIVIDA_SOLIDARIA             AS DIVIDA_SOLIDARIA,
    ENDERECO_PARTE_PROAD             AS ENDERECO_PARTE_PROAD,
    DATA_VENCIMENTO_PROAD            AS DATA_VENCIMENTO_PROAD,
    VALOR_CREDITO_PROAD              AS VALOR_CREDITO_PROAD
  FROM PROJUDI.PROC_PARTE_DEBITO PPD
  INNER JOIN PROJUDI.PROC_DEBITO PD ON PD.ID_PROC_DEBITO = PPD.ID_PROC_DEBITO
  INNER JOIN PROJUDI.PROC_DEBITO_STATUS PDS ON PDS.ID_PROC_DEBITO_STATUS = PPD.ID_PROC_DEBITO_STATUS
  INNER JOIN PROJUDI.PROC_PARTE PP ON PP.ID_PROC_PARTE = PPD.ID_PROC_PARTE
  INNER JOIN PROJUDI.PROC_PARTE_TIPO PPT ON PPT.ID_PROC_PARTE_TIPO = PP.ID_PROC_PARTE_TIPO
  INNER JOIN PROJUDI.PROC P ON PP.ID_PROC = P.ID_PROC
  INNER JOIN PROJUDI.SERV S ON S.ID_SERV = P.ID_SERV
  LEFT JOIN (PROJUDI.GUIA_EMIS GE
  INNER JOIN PROJUDI.GUIA_MODELO GM ON GM.ID_GUIA_MODELO = GE.ID_GUIA_MODELO
  INNER JOIN PROJUDI.GUIA_TIPO GT ON GT.ID_GUIA_TIPO = GM.ID_GUIA_TIPO
  INNER JOIN PROJUDI.GUIA_STATUS GS ON GS.ID_GUIA_STATUS = GE.ID_GUIA_STATUS)
   ON GE.ID_GUIA_EMIS = PPD.ID_GUIA_EMIS;